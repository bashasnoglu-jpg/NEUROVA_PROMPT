(function () {
    "use strict";

    /**
     * NV Slots Loader v1.0
     * - Base-aware: works when serving from /, /NEUROVA_SITE, /NV_SITE, GitHub Pages subpaths, etc.
     * - Override options:
     *   1) window.NV_SLOT_BASE = "/NEUROVA_SITE" (set BEFORE this script)
     *   2) <base href="/NEUROVA_SITE/"> (if you already use it)
     * - Debug: writes data-nv-slot-src="<resolved url>" on slot elements
     */

    function stripTrailingSlashes(s) {
        return (s || "").replace(/\/+$/, "");
    }

    function normalizeBasePath(p) {
        p = stripTrailingSlashes(p);
        if (p === "/") return "";
        return p;
    }

    function getBaseFromBaseTag() {
        const baseEl = document.querySelector("base[href]");
        if (!baseEl) return "";
        try {
            const href = baseEl.getAttribute("href");
            const u = new URL(href, location.href);
            return normalizeBasePath(u.pathname);
        } catch (_) {
            return "";
        }
    }

    function getBaseFromScriptSrc() {
        // Prefer currentScript
        let src = (document.currentScript && document.currentScript.src) || "";
        if (!src) {
            // Fallback: find by filename
            const s = Array.from(document.scripts).find((x) =>
                (x.src || "").includes("nv-slots.js")
            );
            src = s ? s.src : "";
        }
        if (!src) return "";

        try {
            const u = new URL(src, location.href);
            const p = u.pathname;

            // If it contains /assets/, cut everything before it => base path
            const cut = p.indexOf("/assets/");
            if (cut !== -1) return normalizeBasePath(p.slice(0, cut));

            // Else: remove filename and use directory as base
            return normalizeBasePath(p.replace(/\/[^/]*$/, ""));
        } catch (_) {
            return "";
        }
    }

    function getBaseFromLocation() {
        // Directory of current page
        const dir = location.pathname.replace(/\/[^/]*$/, "");
        return normalizeBasePath(dir);
    }

    function getBase() {
        // 1) Explicit override (recommended for special cases)
        if (window.NV_SLOT_BASE && typeof window.NV_SLOT_BASE === "string") {
            return normalizeBasePath(window.NV_SLOT_BASE);
        }
        // 2) <base href="...">
        const baseTag = getBaseFromBaseTag();
        if (baseTag) return baseTag;

        // 3) Derive from this script's src
        const fromScript = getBaseFromScriptSrc();
        if (fromScript) return fromScript;

        // 4) Fallback: current location directory
        return getBaseFromLocation();
    }

    const BASE = getBase();

    function join(base, rel) {
        // Absolute path stays absolute
        if (rel.startsWith("/")) return rel;

        rel = rel.replace(/^\.?\//, ""); // remove leading ./ or /
        if (!base) return "/" + rel;
        return base + "/" + rel;
    }

    // Candidate URL order:
    // 1) BASE-aware first (critical for subpath deploy)
    // 2) Domain-root absolute (good when serving from /)
    // 3) Relative fallbacks (legacy compatibility)
    const DEFAULT_SLOT_MAP = {
        "nv-nav-slot": [
            join(BASE, "nav.html"),
            join(BASE, "partials/nav.html"),
            "/nav.html",
            "/partials/nav.html",
            "../nav.html",
            "./nav.html",
        ],
        "nv-footer-slot": [
            join(BASE, "footer.html"),
            join(BASE, "partials/footer.html"),
            "/footer.html",
            "/partials/footer.html",
            "../footer.html",
            "./footer.html",
        ],
    };

    // Optional per-page override:
    // window.NV_SLOT_MAP = { "nv-nav-slot": ["..."], "nv-footer-slot": ["..."] }
    const SLOT_MAP =
        window.NV_SLOT_MAP && typeof window.NV_SLOT_MAP === "object"
            ? window.NV_SLOT_MAP
            : DEFAULT_SLOT_MAP;

    async function fetchFirst(urls) {
        for (const url of urls) {
            try {
                const res = await fetch(url, { cache: "no-store" });
                if (!res.ok) continue;

                const html = await res.text();
                if (html && html.trim()) return { url, html };
            } catch (_) { }
        }
        return null;
    }

    async function fillSlot(slotId, urls) {
        const el = document.getElementById(slotId);
        if (!el) return { slotId, loaded: false, reason: "missing" };

        const fallback = el.innerHTML;
        const hit = await fetchFirst(urls);

        if (hit) {
            el.innerHTML = hit.html;
            el.setAttribute("data-nv-slot-src", hit.url);
            return { slotId, loaded: true, src: hit.url };
        }

        if (fallback && fallback.trim()) {
            el.innerHTML = fallback;
            return { slotId, loaded: false, reason: "fallback" };
        }

        console.warn("[NV] Slot load failed:", slotId, urls, "BASE=", BASE);
        return { slotId, loaded: false, reason: "failed" };
    }

    // Global promise to await slot readiness
    window.__NV_SLOTS_READY__ = (async () => {
        const results = [];
        for (const [slotId, urls] of Object.entries(SLOT_MAP)) {
            results.push(await fillSlot(slotId, urls));
        }

        document.dispatchEvent(
            new CustomEvent("nv:slots:ready", { detail: results })
        );
        return results;
    })();
})();
