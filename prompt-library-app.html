<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Prompt Library</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
        h1 { text-align: center; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; }
        input, textarea, button { width: 100%; padding: 8px; margin: 5px 0; }
        button { cursor: pointer; }
        .prompt { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; background: #fafafa; }
        .actions { text-align: right; }
        .search { margin-bottom: 15px; }
        .qa-button { margin-top: 10px; background: #1f7fd1; color: #fff; border: none; border-radius: 5px; font-weight: bold; }
        .qa-button:hover { background: #145e9d; }
        .empty-state { text-align: center; color: #888; padding: 20px 0; }
        .toast { position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%); background: #222; color: #fff; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity .2s ease; pointer-events: none; }
        .toast.visible { opacity: 0.9; }
        .toast.success { background: #0a7a2f; }
        .toast.warning { background: #b34700; }
        .modal-overlay, .confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .modal-overlay.active, .confirm-overlay.active { display: flex; }
        .modal, .confirm-modal { background: #fff; padding: 20px; border-radius: 10px; width: min(360px, 90vw); box-shadow: 0 10px 24px rgba(0,0,0,.2); display: flex; flex-direction: column; gap: 10px; }
        .modal-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .modal-actions button, .confirm-modal button { flex: 1; padding: 8px; border-radius: 5px; border: none; cursor: pointer; }
        .modal-actions button:first-child, .confirm-modal button:first-child { background: #e0e0e0; }
        .modal-actions button:last-child, .confirm-modal button:last-child { background: #1f7fd1; color: #fff; }
        .modal-actions button:last-child:hover, .confirm-modal button:last-child:hover { background: #145e9d; }
    </style>
</head>
<body>
<div class="container">
    <h1>Prompt Library</h1>
    <input type="text" id="search" class="search" placeholder="Search prompts...">
    <textarea id="newPrompt" placeholder="Enter your prompt here..."></textarea>
    <button type="button" id="addPromptBtn">Add Prompt</button>
    <div id="promptList"></div>
</div>

<div class="toast" id="toast"></div>
<div class="modal-overlay" id="inputModal">
    <div class="modal">
        <h3 class="modal-title"></h3>
        <input class="modal-input" type="text">
        <div class="modal-actions">
            <button type="button" class="modal-cancel">Cancel</button>
            <button type="button" class="modal-confirm">Save</button>
        </div>
    </div>
</div>
<div class="confirm-overlay" id="confirmModal">
    <div class="confirm-modal">
        <p class="confirm-message"></p>
        <div class="modal-actions">
            <button type="button" class="confirm-cancel">Cancel</button>
            <button type="button" class="confirm-confirm">Delete</button>
        </div>
    </div>
</div>

<script>
    const DEFAULT_PROMPTS = [
        "Act as a product marketing strategist and rewrite this feature announcement for clarity.",
        "Summarize the following text in 5 bullet points for a busy executive.",
        "Generate onboarding talking points for a new team member joining the wellness squad."
    ];

    const MESSAGES = {
        emptyPrompt: "Prompt cannot be empty.",
        duplicatePrompt: "This prompt already exists.",
        editPromptTitle: "Edit prompt",
        editCancelled: "Edit cancelled.",
        deletePrompt: "Are you sure you want to delete this prompt?",
        deleteCancelled: "Delete cancelled.",
        testsComplete: "All tests passed.",
        noResults: "No matching prompts found."
    };

    const toastEl = document.getElementById("toast");
    const inputOverlay = document.getElementById("inputModal");
    const confirmOverlay = document.getElementById("confirmModal");
    const modalTitle = inputOverlay.querySelector(".modal-title");
    const modalInput = inputOverlay.querySelector(".modal-input");
    const modalCancel = inputOverlay.querySelector(".modal-cancel");
    const modalConfirm = inputOverlay.querySelector(".modal-confirm");
    const confirmMessage = confirmOverlay.querySelector(".confirm-message");
    const confirmCancel = confirmOverlay.querySelector(".confirm-cancel");
    const confirmConfirm = confirmOverlay.querySelector(".confirm-confirm");

    let prompts = JSON.parse(localStorage.getItem("prompts") || "null");
    if (!Array.isArray(prompts) || prompts.length === 0) {
        prompts = [...DEFAULT_PROMPTS];
        savePrompts();
    }

    function savePrompts() {
        localStorage.setItem("prompts", JSON.stringify(prompts));
    }

    function showToast(text, variant = "info") {
        toastEl.textContent = text;
        toastEl.className = `toast ${variant} visible`;
        setTimeout(() => {
            toastEl.classList.remove("visible", variant);
        }, 2500);
    }

    function showInputDialog(title, defaultValue = "") {
        return new Promise((resolve) => {
            modalTitle.textContent = title;
            modalInput.value = defaultValue;
            inputOverlay.classList.add("active");
            const cleanup = () => {
                inputOverlay.classList.remove("active");
                modalConfirm.removeEventListener("click", onConfirm);
                modalCancel.removeEventListener("click", onCancel);
                modalInput.removeEventListener("keydown", onKeyDown);
            };
            const onConfirm = () => {
                cleanup();
                resolve(modalInput.value.trim());
            };
            const onCancel = () => {
                cleanup();
                resolve(null);
            };
            const onKeyDown = (event) => {
                if (event.key === "Enter") {
                    event.preventDefault();
                    onConfirm();
                }
            };
            modalConfirm.addEventListener("click", onConfirm);
            modalCancel.addEventListener("click", onCancel);
            modalInput.addEventListener("keydown", onKeyDown);
            modalInput.focus();
        });
    }

    function showConfirmDialog(message) {
        return new Promise((resolve) => {
            confirmMessage.textContent = message;
            confirmOverlay.classList.add("active");
            const cleanup = () => {
                confirmOverlay.classList.remove("active");
                confirmConfirm.removeEventListener("click", onConfirm);
                confirmCancel.removeEventListener("click", onCancel);
            };
            const onConfirm = () => {
                cleanup();
                resolve(true);
            };
            const onCancel = () => {
                cleanup();
                resolve(false);
            };
            confirmConfirm.addEventListener("click", onConfirm);
            confirmCancel.addEventListener("click", onCancel);
        });
    }

    function isDuplicate(text, excludeIndex = -1) {
        return prompts.some((p, idx) => idx !== excludeIndex && p.toLowerCase() === text.toLowerCase());
    }

    function renderPrompts(filter = "") {
        const list = document.getElementById("promptList");
        list.innerHTML = "";
        const normalizedFilter = filter.trim().toLowerCase();
        const filtered = prompts
            .map((prompt, idx) => ({ prompt, idx }))
            .filter(({ prompt }) => prompt.toLowerCase().includes(normalizedFilter));

        if (filtered.length === 0) {
            const emptyState = document.createElement("div");
            emptyState.className = "empty-state";
            emptyState.textContent = MESSAGES.noResults;
            list.appendChild(emptyState);
            return;
        }

        filtered.forEach(({ prompt, idx }) => {
            const div = document.createElement("div");
            div.className = "prompt";
            const content = document.createElement("div");
            content.textContent = prompt;
            const actions = document.createElement("div");
            actions.className = "actions";
            const editBtn = document.createElement("button");
            editBtn.type = "button";
            editBtn.textContent = "Edit";
            editBtn.addEventListener("click", () => handleEditPrompt(idx));
            const deleteBtn = document.createElement("button");
            deleteBtn.type = "button";
            deleteBtn.textContent = "Delete";
            deleteBtn.addEventListener("click", () => handleDeletePrompt(idx));
            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
            div.appendChild(content);
            div.appendChild(actions);
            list.appendChild(div);
        });
    }

    function addPrompt(text = null) {
        const inputText = text !== null ? text.trim() : document.getElementById("newPrompt").value.trim();
        if (!inputText) {
            showToast(MESSAGES.emptyPrompt, "warning");
            return false;
        }
        if (isDuplicate(inputText)) {
            showToast(MESSAGES.duplicatePrompt, "warning");
            return false;
        }
        prompts.push(inputText);
        savePrompts();
        if (text === null) {
            document.getElementById("newPrompt").value = "";
        }
        renderPrompts(document.getElementById("search").value);
        return true;
    }

    function editPrompt(index, newText = null) {
        if (!newText) {
            showToast(MESSAGES.emptyPrompt, "warning");
            return false;
        }
        const cleaned = newText.trim();
        if (!cleaned) {
            showToast(MESSAGES.emptyPrompt, "warning");
            return false;
        }
        if (isDuplicate(cleaned, index)) {
            showToast(MESSAGES.duplicatePrompt, "warning");
            return false;
        }
        prompts[index] = cleaned;
        savePrompts();
        renderPrompts(document.getElementById("search").value);
        return true;
    }

    function deletePrompt(index) {
        prompts.splice(index, 1);
        savePrompts();
        renderPrompts(document.getElementById("search").value);
        return true;
    }

    async function handleEditPrompt(index) {
        const result = await showInputDialog(MESSAGES.editPromptTitle, prompts[index]);
        if (result === null) {
            showToast(MESSAGES.editCancelled, "info");
            return;
        }
        editPrompt(index, result);
    }

    async function handleDeletePrompt(index) {
        const confirmed = await showConfirmDialog(MESSAGES.deletePrompt);
        if (!confirmed) {
            showToast(MESSAGES.deleteCancelled, "info");
            return;
        }
        deletePrompt(index);
    }

    document.getElementById("addPromptBtn").addEventListener("click", () => addPrompt());
    document.getElementById("search").addEventListener("input", (event) => {
        renderPrompts(event.target.value);
    });

    renderPrompts();

    const qaButton = document.createElement("button");
    qaButton.className = "qa-button";
    qaButton.textContent = "Run QA Tests";
    const isQaMode = new URLSearchParams(window.location.search).get("qa") === "1";
    qaButton.style.display = isQaMode ? "block" : "none";
    qaButton.addEventListener("click", runTests);
    document.querySelector(".container").appendChild(qaButton);

    function runTests() {
        console.log("Running Prompt Library Tests...");
        const backup = [...prompts];
        prompts = [];
        savePrompts();
        console.assert(addPrompt("Test Prompt 1") === true, "Test 1 Failed: addPrompt should return true");
        console.assert(prompts.length === 1 && prompts[0] === "Test Prompt 1", "Test 1 Failed: Prompt not added correctly");
        console.assert(editPrompt(0, "Updated Prompt 1") === true, "Test 2 Failed: editPrompt should return true");
        console.assert(prompts[0] === "Updated Prompt 1", "Test 2 Failed: Prompt not updated correctly");
        console.assert(deletePrompt(0) === true, "Test 3 Failed: deletePrompt should return true");
        console.assert(prompts.length === 0, "Test 3 Failed: Prompt not deleted correctly");
        prompts = backup;
        savePrompts();
        renderPrompts(document.getElementById("search").value);
        console.log("All tests completed.");
        showToast(MESSAGES.testsComplete, "success");
    }
</script>
</body>
</html>
