"use strict";

const fs = require("fs");
const path = require("path");

const ROOT = process.cwd();
const PROMPT_DIR = path.join(ROOT, "SANTIS_PROMPT");
const PACKS_DIR = path.join(PROMPT_DIR, "packs");
const INDEX_FILE = path.join(PACKS_DIR, "pack-index.js");
const PL_FILE = path.join(PROMPT_DIR, "prompt-library.html");

function die(msg){ console.error("NV_BUILD_PACK_INDEX ERROR:", msg); process.exit(1); }
function exists(p){ try { fs.accessSync(p); return true; } catch { return false; } }

if (!exists(PROMPT_DIR)) die("Missing SANTIS_PROMPT/");
if (!exists(PACKS_DIR)) die("Missing SANTIS_PROMPT/packs/");
if (!exists(PL_FILE)) die("Missing SANTIS_PROMPT/prompt-library.html");

const files = fs.readdirSync(PACKS_DIR)
  .filter(f => f.toLowerCase().endsWith(".js"))
  .filter(f => f !== "pack-index.js")
  .filter(f => /^pack\..+\.js$/i.test(f))
  .sort((a,b) => a.localeCompare(b, "en"));

const list = files.map(f => `  "./packs/${f}"`).join(",\n");

const js = `/* AUTO-GENERATED by tools/nv-build-pack-index.js
   Source: SANTIS_PROMPT/packs/pack.*.js
   Do not edit manually (edit packs instead).
*/
(function () {
  "use strict";
  window.NV_PACK_LIST = [
${list || "  // (no packs found yet)"}
  ];
})();
`;

fs.writeFileSync(INDEX_FILE, js, "utf8");

// --- SANITY GATE v1.0 (fail-fast for CI) ---
const ENUMS_RAW = JSON.parse(fs.readFileSync(path.join(ROOT, "tools", "nv-enums.node.json"), "utf8"));
const ENUMS = {
  categories: new Set(ENUMS_RAW.categories || []),
  roles: new Set(ENUMS_RAW.roles || [])
};

function runSanityGate(packFilesAbs) {
  const vm = require("vm");

  const sandbox = {
    window: {},
    console,
  };
  sandbox.window.NV_PROMPTS = [];
  sandbox.window.NV_PROMPT_PACKS = {};
  sandbox.NV_PROMPTS = sandbox.window.NV_PROMPTS;

  const ctx = vm.createContext(sandbox);
  const errors = [];
  const warns = [];

  for (const f of packFilesAbs) {
    const code = fs.readFileSync(f, "utf8");
    try {
      vm.runInContext(code, ctx, { filename: f, timeout: 1500 });
    } catch (e) {
      errors.push({ type: "pack_exec_error", file: path.basename(f), err: String(e) });
    }
  }

  const prompts = sandbox.window.NV_PROMPTS || [];
  const seen = new Set();

  for (const p of prompts) {
    if (!p || typeof p !== "object") {
      errors.push({ type: "bad_prompt_shape", prompt: p });
      continue;
    }

    const id = String(p.id || "");
    if (!id) errors.push({ type: "missing_id", title: p.title || "" });
    if (id && seen.has(id)) errors.push({ type: "duplicate_id", id });
    if (id) seen.add(id);

    if (!p.category || !ENUMS.categories.has(p.category))
      errors.push({ type: "bad_category", id, category: p.category });

    if (!p.role || !ENUMS.roles.has(p.role))
      errors.push({ type: "bad_role", id, role: p.role });

    if (!p.safeNote || !String(p.safeNote).trim())
      errors.push({ type: "missing_safenote", id });

    if (!p.tr) warns.push({ type: "missing_tr", id });
    if (!p.en) warns.push({ type: "missing_en", id });
  }

  return { promptsCount: prompts.length, errors, warns };
}

const packAbs = files.map(f => path.join(PACKS_DIR, f));
const sanity = runSanityGate(packAbs);

const outDir = path.join(ROOT, "_audit");
fs.mkdirSync(outDir, { recursive: true });
fs.writeFileSync(
  path.join(outDir, "nv-sanity.report.json"),
  JSON.stringify({ timestamp: new Date().toISOString(), ...sanity }, null, 2),
  "utf8"
);

if (sanity.warns.length) {
  console.log("NV_SANITY WARN:", sanity.warns.length);
}

const STRICT_WARN = process.env.NV_STRICT_WARN === "1";

if (sanity.errors.length) {
  console.error("NV_SANITY FAIL:", sanity.errors.length);
  console.error(sanity.errors.slice(0, 60));
  process.exit(1);
} else {
  if (STRICT_WARN && sanity.warns.length) {
    console.error("NV_SANITY STRICT WARN FAIL:", sanity.warns.length);
    process.exit(1);
  }
  console.log("NV_SANITY OK: prompts=", sanity.promptsCount);
}

let html = fs.readFileSync(PL_FILE, "utf8");
const hasIndex = /\/packs\/pack-index\.js/.test(html);
if (!hasIndex){
  const needle = /<script[^>]+src=["']\.\/prompts-loader\.js["'][^>]*><\/script>/i;
  if (needle.test(html)){
    html = html.replace(needle, `<script src="./packs/pack-index.js"></script>\n  $&`);
  } else if (/<\/head>/i.test(html)){
    html = html.replace(/<\/head>/i, `  <script src="./packs/pack-index.js"></script>\n</head>`);
  } else {
    html = `<script src="./packs/pack-index.js"></script>\n` + html;
  }
  fs.writeFileSync(PL_FILE, html, "utf8");
}

console.log("NV_BUILD_PACK_INDEX OK");
console.log("- packs found:", files.length);
console.log("- wrote:", path.relative(ROOT, INDEX_FILE).replaceAll("\\","/"));
console.log("- ensured include in:", path.relative(ROOT, PL_FILE).replaceAll("\\","/"));
