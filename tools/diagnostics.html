<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Neurova Diagnostics</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 0; padding: 16px; background: #f7f7f7; color: #111; }
    h1 { margin: 0 0 8px; }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .card { background: #fff; border: 1px solid #e5e5e5; border-radius: 12px; padding: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .row { display: flex; justify-content: space-between; gap: 8px; margin: 6px 0; font-size: 14px; }
    .muted { color: #666; font-size: 12px; }
    .badge { padding: 2px 8px; border-radius: 8px; font-size: 12px; font-weight: 600; }
    .ok { background: #e8f5ee; color: #0a7a2f; }
    .warn { background: #fff4e5; color: #aa7a00; }
    .fail { background: #fdecea; color: #b00020; }
    pre { background: #f4f4f4; border: 1px solid #e5e5e5; border-radius: 8px; padding: 10px; overflow: auto; font-size: 12px; }
    button { padding: 8px 12px; border-radius: 10px; border: 1px solid #ddd; background: #fafafa; cursor: pointer; }
    button:hover { background: #f0f0f0; }
    .btn-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>Neurova Diagnostics</h1>
  <p class="muted">Selftest, metrics ve guard özetleri</p>

  <div class="grid">
    <div class="card" id="card-selftest">
      <div class="row">
        <strong>Selftest</strong>
        <span id="selftest-status" class="badge warn">LOAD</span>
      </div>
      <div id="selftest-ts" class="muted"></div>
      <div id="selftest-details" class="muted"></div>
      <div class="btn-row">
        <button id="btn-open-qa">QA modunu aç</button>
        <button id="btn-dump-selftest">Selftest JSON indir</button>
        <button id="btn-dump-pack-errors-log">Pack error log indir</button>
      </div>
    </div>

    <div class="card" id="card-metrics">
      <div class="row">
        <strong>Pack Metrics</strong>
        <span id="metrics-status" class="badge warn">LOAD</span>
      </div>
      <div id="metrics-summary" class="muted"></div>
      <pre id="metrics-packs"></pre>
      <div class="btn-row">
        <button id="btn-refresh-metrics">Yenile</button>
        <button id="btn-download-metrics">metrics.json indir</button>
      </div>
    </div>
  </div>

  <script>
    function downloadJson(obj, name) {
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = name;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function loadMetrics() {
      try {
        const res = await fetch("../packs/metrics.json", { cache: "no-store" });
        if (!res.ok) throw new Error("metrics fetch failed: " + res.status);
        const data = await res.json();
        const statusEl = document.getElementById("metrics-status");
        statusEl.textContent = "OK";
        statusEl.className = "badge ok";

        const summary = document.getElementById("metrics-summary");
        summary.textContent = `coverage ${data.coverage}% | prompts ${data.totals?.totalPrompts ?? "?"} | packs ${data.manifestPacks ?? "?"}`;

        const packs = data.packs || {};
        const lines = Object.entries(packs).map(([name, p]) => {
          return `${name}: prompts=${p.prompts}, bytes=${p.bytes}, errors=${p.errors}, parseOk=${p.parseOk}`;
        });
        document.getElementById("metrics-packs").textContent = lines.join("\\n");
        document.getElementById("btn-download-metrics").onclick = () => downloadJson(data, "metrics.json");
      } catch (e) {
        const statusEl = document.getElementById("metrics-status");
        statusEl.textContent = "FAIL";
        statusEl.className = "badge fail";
        document.getElementById("metrics-summary").textContent = e.message;
      }
    }

    function loadSelftest() {
      const statusEl = document.getElementById("selftest-status");
      const tsEl = document.getElementById("selftest-ts");
      const detailsEl = document.getElementById("selftest-details");

      const ok = window.__NV_SELFTEST_OK__;
      const last = window.__NV_SELFTEST_LAST__;
      if (ok === undefined || !last) {
        statusEl.textContent = "N/A";
        statusEl.className = "badge warn";
        detailsEl.textContent = "Selftest henüz çalışmadı. QA modunda veya konsolda NV_OBS_SELFTEST_RUN() ile tetikle.";
        document.getElementById("btn-dump-selftest").disabled = true;
        return;
      }

      statusEl.textContent = ok ? "OK" : "FAIL";
      statusEl.className = "badge " + (ok ? "ok" : "fail");
      tsEl.textContent = last.ts || "";

      const failing = Object.entries(last.checks || {}).filter(([_, v]) => !v).map(([k]) => k);
      detailsEl.textContent = failing.length ? ("Failing: " + failing.join(", ")) : "Tüm kontroller geçti.";
      document.getElementById("btn-dump-selftest").disabled = false;
      document.getElementById("btn-dump-selftest").onclick = () => downloadJson(last, "selftest.json");
      document.getElementById("btn-dump-pack-errors-log").onclick = () => {
        const log = Array.isArray(window.__NV_PACK_ERRORS_LOG__) ? window.__NV_PACK_ERRORS_LOG__ : [];
        downloadJson(log, "pack-errors-log.json");
      };
    }

    document.getElementById("btn-open-qa").addEventListener("click", () => {
      const url = "../prompt-library.html?qa=1";
      window.open(url, "_blank");
    });
    document.getElementById("btn-refresh-metrics").addEventListener("click", loadMetrics);

    // Health page loads without selftest context, but if opened from QA tab it will show last result.
    loadMetrics();
    loadSelftest();
  </script>
</body>
</html>
